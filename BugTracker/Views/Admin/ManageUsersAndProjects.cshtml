@model IEnumerable<BugTracker.ViewModels.IndexUsersViewModel>


<!-- MODAL FORM -->

<div class="modal fade" id="assignProject" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Assign Project To User</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="container">
                    <div class="row">
                        <div class="form-group hidden">
                            <input id="HiddenField" type="text" style="display:none" class="hidden" />

                        </div>
                    </div>
                    <div class="row">

                        <div class="col-md-12">

                            <div class="ui message">
                                <div class="header">
                                    <span id="user_name"></span>
                                </div>
                                <hr />
                                <input type="hidden" id="userID" name="userID" value="" />

                                <ul class="list">
                                    <li><b>Role:</b>  <span id="role"></span></li>
                                    <li><b>Email:</b> <span id="email"></span></li>

                                </ul>
                            </div>

                        </div>


                    </div>

                    <div class="row mt-4">



                        <div class="col-md-3">
                            <h4>Select a project:</h4>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                @Html.DropDownList("ProjecstIds", null, "-- Select A Project --", new { @class = "h5" })

                            </div>
                        </div>

                        <div class="col-md-6 hidden" style="display:none">
                            <input name="FirstName" type="text" class="form-control" id="FirstName" />
                        </div>

                    </div>

                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" id="assignToProject" disabled data-dismiss="modal" class="btn btn-primary">Assign User</button>

            </div>
        </div>
    </div>
</div>

<!--  END OF MODAL -->


<div class="col-md-6">
    <div class="card card-default">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-user-tie"></i>
                Users
            </h3>
        </div>
        <!-- /.card-header -->


        @foreach (var userInfo in Model)
        {


            <div class="card-body">
                <div class="callout callout-success">

                    <h5>@userInfo.User.FullName -- @userInfo.role.First()</h5>

                    <img src="@userInfo.User.AvatarUrl" style="width:15%;" alt="@userInfo.User.FullName" class="img-circle" data-lock-picture="@userInfo.User.AvatarUrl" />

             
                    <button type="button"  class="ui mini orange button ml-3 btnClickable" data-email="@userInfo.User.Email" data-toggle="modal" data-target="#assignProject" data-role="@userInfo.role.First()" data-id="@userInfo.User.Id" data-name="@userInfo.User.FirstName @userInfo.User.LastName">
                        Assign Project
                    </button>
                    <p>
                        <h4> Projects Assigned to User</h4>
                    </p>

                    <!--  Begin Table -->
                    
                    <table id="projectsUser-@userInfo.User.Id" class="table table-bordered table-hover table-striped" style="width:100%">

                        <thead>
                            <tr>
                                <th style="width:5%">
                                    Name
                                </th>
                                <th>
                                    Description
                                </th>
                                <th>
                                    Date Created
                                </th>

                                <th>
                                    Actions
                                </th>


                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var project in userInfo.Projects)
                            {

                                <tr>
                                    <td class="">
                                        @Html.DisplayFor(item => project.Name)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(item => project.Description)

                                    </td>
                                    <td class="">
                                        @Html.DisplayFor(item => project.Created)
                                    </td>
                                    <td class="">
                                        @Html.ActionLink("Remove", "RemoveUser", "Admin", new { id = userInfo.User.Id, projectID = project.Id }, new { @class = "ui mini red  button" })
                                    </td>
                                </tr>

                            }

                        </tbody>


                    </table>

                    <!--  Begin Table -->

                </div>

                <!-- /.card-body -->
            </div>

        }
        <!-- /.card -->
    </div>

</div>

@section scripts    {

    <script>
        let tableID;

        $('#ProjecstIds').change(function () {
        selectVal = $('#ProjecstIds').val();

        if (selectVal == 0) {
            $('#assignToProject').prop("disabled", true);
        }
        else {
            $('#assignToProject').prop("disabled", false);
        }
    });


        $('#assignToProject').click(function () {

            var projectId = $("#ProjecstIds option:selected").val()
            var userId = $("#userID").val();
           // var lastRow = $(this).closest("tbody:last");
           // var tableId = $(this).closest('.card-body').find('table').attr('id');

            $.ajax({
                type: "POST",
                url: "/Admin/AssignUserProject",
                data: JSON.stringify({
                    userId: userId,
                    projectID: projectId
                }),
                dataType: "json",
                contentType: 'application/json; charset=utf-8',
                complete: function (data) {
                    populateProjectTable(tableID,data);
                },
                error: function (xhr, status, error) {

                }
            });

        });


        var arr;

        $('#userTable tr').click(function (event)
        {

            if (event.target.type !== 'checkbox')
            {
                $(':checkbox', this).trigger('click');
            }
           
            if ($(':checkbox', this).is(":checked"))
            {
                arr = $(this).closest("tr").find("#item_Id").val();
               
            }

  
        });

        var populateProjectTable = function (tableId,data)
        {

             var table = document.getElementById(tableId).getElementsByTagName('tbody')[0];
             var newRow = table.insertRow();

             var cellOne = newRow.insertCell(0);
             var cellTwo = newRow.insertCell(1);
             var cellThree = newRow.insertCell(2);
             var cellFour = newRow.insertCell(3);

             cellOne.innerHTML = data.responseJSON.Name;
             cellTwo.innerHTML = data.responseJSON.Description;
             cellThree.innerHTML = data.responseJSON.Created;
             cellFour.innerHTML = "<a class=\"ui mini red button\" href=\"\/Admin\/Removeruser\/" +   data.responseJSON.userId +"?projectID=" + data.responseJSON.projectID + "\"" + ">Remove</a>";

        }

         $(".btnClickable").click(function () {
                       
              var user_id = $(this).data('id');
              var user_name = $(this).data('name');
              var user_role = $(this).data('role');
              var user_email = $(this).data('email');
              $("#user_name").text(user_name);
              $("#role").text(user_role);
              $("#email").text(user_email);
              $("#userID").val(user_id);
              tableID = $(this).closest('.card-body').find('table').attr('id');
        });

    </script>
}











